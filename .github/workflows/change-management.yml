name: Trigger Change Management

on:
  workflow_run:
    workflows: ["Release Piper Action"]
    types:
      - completed

permissions:
  contents: read

jobs:
  trigger_change_management:
    name: Trigger Change Management Workflow
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest release info
        id: release
        run: |
          gh release view --json tagName,url,name > release.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse release info
        id: parse
        run: |
          tag_name=$(jq -r .tagName release.json)
          release_url=$(jq -r .url release.json)
          release_name=$(jq -r .name release.json)
          echo "tag_name=$tag_name" >> $GITHUB_OUTPUT
          echo "release_url=$release_url" >> $GITHUB_OUTPUT
          echo "release_name=$release_name" >> $GITHUB_OUTPUT

      - name: Trigger change-management workflow in private repo
        run: |
          set -e
          response=$(curl -L \
            -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.CHANGE_MANAGEMENT_TOKEN }}" \
            -w "%{http_code}" \
            --max-time 30 \
            "${{ secrets.CHANGE_MANAGEMENT_API_URL }}/dispatches" \
            -d '{
                  "event_type": "change-management",
                  "client_payload": {
                    "tag_name": "${{ steps.parse.outputs.tag_name }}",
                    "release_url": "${{ steps.parse.outputs.release_url }}",
                    "release_name": "${{ steps.parse.outputs.release_name }}"
                  }
                }')

          status_code=${response: -3}
          body=$(echo "$response" | head -c -3)
          echo "Response body: $body"
          echo "HTTP status: $status_code"
          if [ "$status_code" -ne 204 ]; then
            echo "::error title=Change Management Trigger Failed::Status code: $status_code. Response body: $body"
            exit 1
          fi
